include/master-slave.inc
[connection master]
connection master;
create table t1 (a int) engine=innodb;
include/sync_slave_sql_with_master.inc
connection slave;
include/stop_slave.inc
change master to master_delay=3, master_use_gtid=Slave_Pos;
include/start_slave.inc
connection slave;
LOCK TABLE t1 WRITE;
connection master;
insert into t1 values (1);
connection slave;
# Waiting for first transaction to start executing on slave..
connection master;
insert into t1 values (2);
include/save_master_gtid.inc
connection slave;
# Waiting for second transaction to delay on slave..
# Sleep to bump SBM > 0
connection slave;
# Waiting for second transaction to begin executing..
# Sleep to bump SBM > SQL_Delay
# Unlock tables to allow both transactions to complete on slave
UNLOCK TABLES;
include/sync_with_master_gtid.inc
#
# Cleanup
connection slave;
# Reset master_delay
include/stop_slave.inc
CHANGE MASTER TO master_delay=0, master_use_gtid=No;
include/start_slave.inc
connection master;
DROP TABLE t1;
include/save_master_gtid.inc
connection slave;
include/sync_with_master_gtid.inc
include/rpl_end.inc
# End of rpl_delayed_parallel_slave_sbm.test
