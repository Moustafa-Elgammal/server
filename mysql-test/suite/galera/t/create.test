--source include/galera_cluster.inc
--source include/have_innodb.inc

--echo #
--echo # MDEV-6924 : Server crashed on CREATE TABLE ... SELECT
--echo #

SET @wsrep_forced_binlog_format_saved=@@GLOBAL.wsrep_forced_binlog_format;
SET @@GLOBAL.wsrep_forced_binlog_format=STATEMENT;

# @@log_bin must be OFF
SHOW VARIABLES LIKE '%log%bin%';

USE test;
CREATE TABLE t1(i INT) ENGINE=INNODB;
INSERT INTO t1 VALUES(1);
CREATE TEMPORARY TABLE `t1_temp` AS SELECT * FROM `t1` WHERE i = 1;
SELECT * FROM t1;
SELECT * FROM t1_temp;

# Cleanup
DROP TABLE t1;
SET @@GLOBAL.wsrep_forced_binlog_format=@wsrep_forced_binlog_format_saved;

--echo #
--echo # MDEV-7673: CREATE TABLE SELECT fails on Galera cluster
--echo #
--connection node_1
CREATE TABLE t1 (i INT) ENGINE=INNODB DEFAULT CHARSET=utf8 SELECT 1 as i;
SELECT * FROM t1;

--connection node_2
SELECT * FROM t1;
# Cleanup
DROP TABLE t1;

--echo #
--echo # MDEV-8166 : Adding index on new table from select crashes Galera
--echo # cluster
--echo #
--connection node_1
CREATE TABLE t1(i int(11) NOT NULL DEFAULT '0') ENGINE=InnoDB DEFAULT CHARSET=utf8;
INSERT INTO t1(i) VALUES (1), (2), (3);

CREATE TABLE t2 (i INT) SELECT i FROM t1;
ALTER TABLE t2 ADD INDEX idx(i);

SELECT * FROM t2;

--connection node_2
SELECT * FROM t2;
SHOW CREATE TABLE t2;

# Cleanup
DROP TABLE t1, t2;

--echo #
--echo # MDEV-9853: WSREP says it cannot get fake InnoDB transaction ID
--echo # followed by segmentation fault
--echo #
CREATE TABLE `t1`(`c1` INT) ENGINE=INNODB;

SET autocommit=0;
CREATE TABLE `t2` (`c1` INT) ENGINE=INNODB SELECT * FROM t1;
COMMIT;
SET autocommit=1;

# Cleanup
DROP TABLE t1, t2;


--echo #
--echo # MDEV-10235: Deadlock in CREATE TABLE ... AS SELECT .. if result set
--echo # is empty in Galera
--echo #
--connection node_1
CREATE TABLE t1(c1 INT) ENGINE=INNODB;
INSERT INTO t1 VALUES(1);
CREATE TABLE t2 AS SELECT * FROM t1 WHERE c1=2;

--connection node_2
SELECT * FROM t1;
SELECT * FROM t2;
# Cleanup
DROP TABLE t1, t2;

--echo #
--echo # MDEV-29824 Galera crashes when running CoR for a locked table
--echo #
--connection node_1
SET autocommit=0;
CREATE TABLE t0 (x INT,y INT);
LOCK TABLES t0 WRITE;
CREATE OR REPLACE TABLE t0 SELECT 1;
DROP TABLE t0;

--echo #
--echo # MDEV-29831 Galera crashes when running CoR for a locked table after
--echo #            setting the minimum memory for a user session
--echo #
--connection node_1
SET @max_mem_save= @@session.max_session_mem_used;
SET SESSION max_session_mem_used= 8192;
CREATE TABLE t1 (a INT, KEY(a)) ENGINE=InnoDB;
SET autocommit=OFF;
CREATE TABLE t2 (id INT NOT NULL PRIMARY KEY, DATA INT) ENGINE=MEMORY;
--error ER_OPTION_PREVENTS_STATEMENT
INSERT INTO t2(id) VALUES ('11');
--error ER_OPTION_PREVENTS_STATEMENT
ALTER TABLE t1 ADD COLUMN f3 INT NOT NULL DEFAULT 10;
LOCK TABLE t1 WRITE, t2 READ;
--error ER_QUERY_INTERRUPTED
CREATE OR REPLACE TABLE t1 SELECT 1;
UNLOCK TABLES;
DROP TABLES t2, t1;
SET SESSION max_session_mem_used= @max_mem_save;

--source include/galera_end.inc
--echo # End of tests
